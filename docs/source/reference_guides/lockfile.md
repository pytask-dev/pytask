# The Lock File

`pytask.lock` is the default state backend. It stores task state in a portable,
git-friendly format so runs can be resumed or shared across machines.

```{note}
SQLite is the legacy format. It is still read when no lockfile exists, and a lockfile
is written during that first run. Subsequent runs use the lockfile only.
```

## Example

```toml
# This file is automatically @generated by pytask.
# It is not intended for manual editing.

lock-version = "1"

[[task]]
id = "src/tasks/data.py::task_clean_data"
state = "f9e8d7c6..."

[task.depends_on]
"data/raw/input.csv" = "e5f6g7h8..."

[task.produces]
"data/processed/clean.parquet" = "m3n4o5p6..."
```

## Behavior

On each run, pytask:

1. Reads `pytask.lock` (if present).
1. Compares current dependency/product/task `state()` to stored `state`.
1. Skips tasks whose states match; runs the rest.
1. Updates `pytask.lock` after each completed task (atomic write).

`pytask-parallel` uses a single coordinator to write the lock file, so writes are
serialized even when tasks execute in parallel.

## Portability

There are two portability concerns:

1. **IDs**: Lockfile IDs must be project‑relative and stable across machines.
1. **State values**: `state` is opaque; portability depends on each node’s `state()`
   implementation. Content hashes are portable; timestamps are not.

## Maintenance

Use `pytask build --clean-lockfile` to rewrite `pytask.lock` with only currently
collected tasks. The rewrite happens after a successful build and recomputes current
state values without executing tasks again.

## File Format Reference

### Top-Level

| Field          | Required | Description                      |
| -------------- | -------- | -------------------------------- |
| `lock-version` | Yes      | Schema version (currently `"1"`) |

### Task Entry

| Field        | Required | Description                   |
| ------------ | -------- | ----------------------------- |
| `id`         | Yes      | Portable task identifier      |
| `state`      | Yes      | Opaque state string           |
| `depends_on` | No       | Mapping from node id to state |
| `produces`   | No       | Mapping from node id to state |

### Dependency/Product Entry

Node entries are stored as key-value pairs inside `depends_on` and `produces`, where the
key is the node id and the value is the node state string.

## Version Compatibility

Only lock-version `"1"` is supported. Older or newer versions error with a clear upgrade
message.

## Implementation Notes

- The lockfile is encoded/decoded with `msgspec`’s TOML support.
- Writes are atomic: pytask writes a temporary file and replaces `pytask.lock`.
