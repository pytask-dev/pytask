# The Lock File

`pytask.lock` is the default state backend. It stores task state in a portable,
git-friendly format so runs can be resumed or shared across machines.

```{note}
SQLite is the legacy format. It is still read when no lockfile exists, and a lockfile
is written during that first run. Subsequent runs use the lockfile only.
```

## Example

```toml
# This file is automatically @generated by pytask.
# It is not intended for manual editing.

lock-version = "1.0"

[[task]]
id = "src/tasks/data.py::task_clean_data"

[task.state]
value = "f9e8d7c6..."

[[task.depends_on]]
id = "data/raw/input.csv"

[task.depends_on.state]
value = "e5f6g7h8..."

[[task.produces]]
id = "data/processed/clean.parquet"

[task.produces.state]
value = "m3n4o5p6..."
```

## Behavior

On each run, pytask:

1. Reads `pytask.lock` (if present).
1. Compares current dependency/product/task `state()` to stored `state.value`.
1. Skips tasks whose states match; runs the rest.
1. Updates `pytask.lock` after each completed task (atomic write).

`pytask-parallel` uses a single coordinator to write the lock file, so writes are
serialized even when tasks execute in parallel.

## Portability

There are two portability concerns:

1. **IDs**: Lockfile IDs must be project‑relative and stable across machines.
1. **State values**: `state.value` is opaque; portability depends on each node’s
   `state()` implementation. Content hashes are portable; timestamps are not.

## File Format Reference

### Top-Level

| Field          | Required | Description                        |
| -------------- | -------- | ---------------------------------- |
| `lock-version` | Yes      | Schema version (currently `"1.0"`) |

### Task Entry

| Field   | Required | Description                                  |
| ------- | -------- | -------------------------------------------- |
| `id`    | Yes      | Portable task identifier                     |
| `state` | Yes      | State dictionary with a single `value` field |

### Dependency/Product Entry

| Field   | Required | Description                                  |
| ------- | -------- | -------------------------------------------- |
| `id`    | Yes      | Node identifier                              |
| `state` | Yes      | State dictionary with a single `value` field |

### State Dictionary

| Field   | Required | Description         |
| ------- | -------- | ------------------- |
| `value` | Yes      | Opaque state string |

## Version Compatibility

- **Upgrade**: newer pytask upgrades old lock files in memory and writes the new format
  on the next update.
- **Downgrade**: older pytask errors with a clear upgrade message.
